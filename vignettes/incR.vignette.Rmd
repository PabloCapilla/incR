---
title: "Suggested workflow using the incR package"
author: "Pablo Capilla"
date: "`r Sys.Date()`"
output: pdf_document
vignette: >
  %\VignetteIndexEntry{Workflow using the incR package}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

# 1 - Introduction
 
In this short vignette I would like to describe a recommended workflow to analyse
incubation behaviour using the *incR package*. This package is currently available
through GitHub. It is in active development and the user should not expect to
find either high quality code or perfect documentation. However, it is 
my intention to further develop both if the method results to be appropriate.

My main aim writing this report is to introduce the functions to potential users
in order to provide a piece of code they can use and, at the same time, evaluate
the usefulness of the functions that this package contains in a wide suite of circunstances.

## 1.1 - The package in short
 
*incR* contains three types of functions. *incRprep* takes a raw time series
of temperatures and creates new useful columns for further analysis. 
The rest of the functions in the package have been customised to easily accommodate
the data frame that *incRprep* returns.

The main function in *incR* is *incRscan*. This function implements an
algorithm that scans a temperature time-series and comes up with
suggested positions for the incubating individual, these "positions" being 
"inside the nest" (coded as 1) or "outside the nests" (coded as 0). 
This algorithm is, in essence, not totally new. It extends the approach of Rhythm and Raven [1] to perform daily auto-calibration of temperatures thresholds. *incRscan*
analyses temperature variation between pairs of consecutive points,
potentically increasing the sensitibity to detect short off-bouts. 

At the heart of *incR* lays *incRscan*; however, *incR* aims at being more than only
such function. If the job of *incRscan* is performed by other means, *incR*
provides a suite of functions that allow the extraction of biogically meaningful
metrics from a series of observations of the incubating individual.

## 1.2 - Description of the algorithm implemented by *incRscan*
Need to be completed

# 2 - Workflow: from raw data to biological metrics

### 2.1 - Getting the package into your computer

The very first step is to download *incR* from GitHub, to do so you will
need to install the *devtools* package.
```{r eval=FALSE}
install.packages("devtools")  # install "devtools"
```
Then, *incR* can be downloaded:
```{r eval=FALSE}
devtools::install_github("PabloCapilla/incR")
```
```{r}
library(incR) # attaching incR
```

### 2.2 - Read your data and format it using *incRprep* 

In this vignette I use example data provided with the *incR* package. These data
come from a blue tit nest monitored in Glasgow in 2015 and belong to Barbara Helm and
Davide Dominoni, who kindly allowed me to reproduce these data here.
```{r}
data(incRdataExample) #reading data
df <- incRdataExample
```
```{r echo=FALSE}
df$PRESENCE <- NULL
df$ENTERING <- NULL
df$LEAVING <- NULL
df$MISSED <- NULL
df$valueH <- NULL
```
```{r}
str(df) # preliminar exploration
```
Now, *incRprep* is applied to the *df* object to prepared the data for further analysis:
```{r}
df.prep <- incRprep (data= df,                   
                      date.name="DATE",         
                      date.format="%d/%m/%Y %H:%M",
                      timezone="GMT",
                      temperature.name="valueT")
```

### 2.3 - Apply the *incR* algorithm and estimate the position of the inc. individual
 
The algorithm has been explained above and now it is used on the object returned by
*incRprep*. The specified parameters have been checked by comparing their performance
against video-calibrated data, yielding very high correspondence (>95%) between the estimated position of the incubating individual using this algorithm and video-camera
observations.
```{r}
inc.example <- incRscan (data=df.prep,            # data frame
                          lower.time=22,           # beginning of calibrating window
                          upper.time=3,            # end of calibrating window
                          maxinc.Temp=38,          # temperature of incubation
                          sensitivity=0,           # correction when nest Tª is 
                                                   # far below maxinc.Temp 
                          time.dif=20,             # diff in Tª from maxinc.Temp that 
                                                   # triggers sensitivity change
                          maxNightVar_accepted=2,  # max night variation accepted in 
                                                   # calibrating windows
                          env.data=FALSE)          # is environmental data provided?
```
As you see, you get a warning messages. These warnings are 
thought to be informative
and will tell you something about your data. Most likely, they will mean
days without a previous calibrating window (eg. if your data series starts at
11am, then that day won't be assessed as they is no calibrating window available
before - as in the example above). Check them but do not assume the function did not work, probably it did. Further versions of this function will store these messages in a
separated data frame, rather than being generated as warnings.
 
*incRscan* produces a list with 2 objects. In the first of these, you will 
find your original data set plus an additional column called *inc.vector*. 
This variable contains the sequences of on- and off-bouts. In the second object of the list, there is a data frame with information about
temperature threshold per day employed to detect on- and off-bouts. See above for more
details. More information on this object can be found in ?incRscan.
 
From now on, I am going to focused on the first object of the *inc.example*.
The rest of the functions in *incR* are designed to calculate biological metrics
based on the *inc.vector* object returned by *incRscan*. 
Visualization of the results of *incRscan* is highly 
recommended and I included here basic code for it.

```{r}
# selecting the object of interest
df.incubation <- inc.example[[1]]
```
#### 2.3.1 - Plotting the results of *incRscan*
 
I use Using only one day to increase the resolution of the plot:
```{r}
# selecting one day of incubation
plot.example <- df.incubation[df.incubation$date=="2015-05-07",]
# plot
plot (valueT ~ dec.time, data=plot.example,
      pch=19, 
      main=list("Blue tit incubation 07/05/2015"),
      col=c("red", "black")[plot.example$inc.vector+1],# pch color defined by "inc.vector"
      xaxt="n", las=1, cex.axis=1.5,# no x-axis, horizontal y axis-labels and size
      xlab=list("Time", cex=1.5),
      ylab=list("Temperature (ºC)", cex=1.5))
axis (side=1,                       # x-axis
      at= plot.example$dec.time,    # location of marks
      labels=plot.example$time)     # label for marks
legend ("bottomleft", bty="n", 
        pch=c(19,19),
        col=c("red", "black"),
        legend=c("Ind. in", "Ind. out"), cex=1.3)
```

### 2.4 - Using incR to extract biologically relevant metrics of incubation
 
#### 2.4.1 - Daily activity times
 
First, I calculate onset and offset times of activity using the function **incRactivity**.
```{r}
df.activity <- incRactivity (data=df.incubation, 
                              vector.incubation ="inc.vector")
```
Have a look at the new data frame with activity times:
```{r}
df.activity
```
It contains onset and offset of activity per day. WARNING: this function
returns the first off-bout and last on-bout of a day. If the time series is
incompleted for one day, onset or offset times should be discarded, as it happens
in the example above for the offset time on 2015-05-08. On that day the temperature
recording ended around 13:30, and the last on-bout was around 13:15 (see table above). 
One should check that the days of analysis are completed before concluding on
the biology of the results.
 
You can include activity times
in the plot above (the code is not shown to save space) to check the performance
of the function:
 
```{r echo=FALSE}
plot (valueT ~ dec.time, data=plot.example,
      pch=19, 
      main=list("Blue tit incubation 07/05/2015"),
      col=c("red", "black")[plot.example$inc.vector+1],# pch color defined by "inc.vector"
      xaxt="n", las=1, cex.axis=1.5,        # no x-axis, horizontal y axis-labels and size
      xlab=list("Time", cex=1.5),
      ylab=list("Temperature (ºC)", cex=1.5))
axis (side=1,                          # x-axis
      at= plot.example$dec.time,       # location of marks
      labels=plot.example$time)        # labels of marks
legend ("bottomleft", bty="n",         # legend
        pch=c(19,19),
        col=c("red", "black"),
        legend=c("Ind. in", "Ind. out"), cex=1.3)
abline (v=c(df.activity[1,c(2:3)]), lty=2, col="grey", lwd=2) # lines for onset and offset
``` 
*Dashed grey lines represent onset and offset of activity.*
 
#### 2.4.2 - Daily incubation constancy
 
The function *incRconstancy* automates the calculation of the daily percentage 
of time the incubating individual stayed in the nest. The current version of 
the *incR* package performs this calculation over 24h. Future developments
will allow the separation between day/night or other specified time windows.
*incRconstancy* assumes that the rate of sampling is constant over the analysed period
of time.
```{r}
inc.constancy <- incRconstancy (data=df.incubation,      
                                 vector.incubation ="inc.vector")
inc.constancy
```
Results are stored in a data frame and for each day of analysis the proportion
of time in the nests is shown under the *perc.in* column.
 
#### 2.4.3 - Number of on- and off-bouts per day
```{r}
# calculation of sampling rate - which is constant for the entire time-series
sr <- df.incubation$dec.time[5]-df.incubation$dec.time[4]
bouts.example <- incRbouts (data=df.incubation, 
                             vector.incubation="inc.vector", 
                             sampling.rate=sr)
bouts.example
```
A five-column data frame is produced with one day per raw. Date, number on-bouts,
number of off-bouts (number of on-bouts + 1 by definition) and 
mean time duration of on- and off-bouts are displayed in the 5 columns 
respectively. Mean times are shown in the unit you specify *sampling.rate* -
decimal hours in this example.

#### 2.4.4 - Temperature variation for customised time intervals
 
*incRt* allows the user to calculate temperature averages and variation between
two time windows within 24 hours. It was originally thought to calculate
incubation temperatures between day and night. The current version 
includes three ways of defining "day" and "night". Here I use the onset and offset of 
activity times calculated by *incRactivity* to define the two day periods, *day*
and *night* if one likes. Check the *incRt* help page to find out more about the functionally of this function.
```{r eval=FALSE}
?incRt
```
If this option is chosen, one must check that there is a column under the *inc.vector*
name giving the position of the incubating individual for each time point:
```{r}
is.null(df.incubation$inc.vector)
head (df.incubation$inc.vector, 5)
```
Once that has been checked, the function can be run:
```{r}
incRt (data=df.incubation, 
        limits=NULL, 
        coor=NULL, 
        civil.twilight=FALSE, 
        activity.times=TRUE, 
        time.zone="GMT")
```
In this example I calculate temperatures based on acitivity times estimated by
*incRactivity*. Note that there are no night calculations for the 8th of May.
Such night is defined by the offset of activity of the 8th and the onset of 
activity of the 9th. There are no data for the 9th and, therefore, such calculation
cannot be made.
 
*****

# 3- References
 
* Cooper CB, Mills H. 2005. New software for quantifying incubation behavior from 
  time-series recordings. Journal of Field Ornithology 76(4): 352-356.
 
